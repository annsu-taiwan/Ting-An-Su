<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Coffee 線上點餐</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
        .product { background: rgb(254, 254, 254); padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .cart-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgb(205, 204, 204); color: white; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        .hidden { display: none; }
        .product button {font-size: 12px; color: white; padding: 5px 10px; background: rgb(205, 204, 204); border-radius: 5px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <h2>☕ Deep Coffee</h2>
    
    <div id="product-list">
        <div class="product">
            <div>
                <h3>布朗尼</h3>
                <p>$120</p>
            </div>
            <button onclick="addToCart('招牌拿鐵', 120)">+ 加入</button>
        </div>
        <div class="product">
            <div>
                <h3>生巧克力塔</h3>
                <p>$100</p>
            </div>
            <button onclick="addToCart('經典美式', 100)">+ 加入</button>
        </div>
    </div>

    <div id="checkout-form" class="hidden">
        <h3>填寫資料</h3>
        <p id="cart-summary"></p>
        <input type="text" id="user-phone" placeholder="您的手機號碼">
        <button onclick="submitOrder()" style="width:100%; background:#06c755; color:white; padding:15px; border:none; border-radius:5px; margin-top:10px;">送出訂單</button>
        <button onclick="location.reload()" style="width:100%; background:#ccc; padding:10px; margin-top:10px; border:none; border-radius:5px;">重選</button>
    </div>

    <div class="cart-bar" onclick="showCheckout()">
        購物車 (<span id="count">0</span>) - 結帳
    </div>

    <script>
        // 設定區
        const LIFF_ID = 'YOUR_LIFF_ID'; // 請替換您的 LIFF ID
        const GAS_API = 'https://script.google.com/macros/s/AKfycbxAuM_YOnaQLaDzCfIXmsucHLfQqEzC8qfvMdlfIC9_m2yclWLIcXuaiZcihe2ZyzVg/exec'; // 請替換您的 Apps Script 網址

        let cart = [];
        let userProfile = { name: 'Guest' };

        // 初始化 LIFF
        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                userProfile.name = profile.displayName;
            } else {
                liff.login();
            }
        }
        main();

        function addToCart(name, price) {
            cart.push({ name, price, qty: 1 });
            updateUI();
        }

        function updateUI() {
            document.getElementById('count').innerText = cart.length;
        }

        function showCheckout() {
            if(cart.length === 0) return alert('購物車是空的');
            document.getElementById('product-list').classList.add('hidden');
            document.getElementById('checkout-form').classList.remove('hidden');
            
            let total = cart.reduce((a, b) => a + b.price, 0);
            let summary = cart.map(i => i.name + " $" + i.price).join("<br>");
            document.getElementById('cart-summary').innerHTML = summary + "<br><hr><b>總計: $" + total + "</b>";
        }

        function submitOrder() {
            const phone = document.getElementById('user-phone').value;
            if(!phone) return alert('請輸入電話');

            // 顯示載入中...
            const btn = event.target;
            btn.innerText = "連線 LINE Pay 中...";
            btn.disabled = true;

            const orderData = {
                user: { name: userProfile.name, phone: phone },
                cart: cart,
                totalPrice: cart.reduce((a, b) => a + b.price, 0)
            };

            fetch(GAS_API, {
                method: 'POST',
                body: JSON.stringify(orderData),
            })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    // 成功獲得 LINE Pay 付款連結，進行跳轉
                    window.location.href = data.paymentUrl;
                } else {
                    alert('系統錯誤: ' + data.message);
                    btn.innerText = "送出訂單";
                    btn.disabled = false;
                }
            })
            .catch(err => {
                // 因 GAS 跨域有時會沒回傳標準 JSON，若是 no-cors 模式需注意
                // 建議這裡使用標準 fetch，GAS 部署需設為 "Anyone"
                alert('連線錯誤，請檢查網路或稍後再試');
                btn.innerText = "送出訂單";
                btn.disabled = false;
            });
        }
            
    </script>
</body>
</html>
